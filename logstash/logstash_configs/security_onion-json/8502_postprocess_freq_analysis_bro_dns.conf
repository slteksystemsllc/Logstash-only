# Author: Justin Henderson
#         SANS Instructor and author of SANS SEC555: SIEM and Tactical Analytics
# Email: justin@hasecuritysolutions.com
# Last Update: 4/11/2017

filter {
  if [event_type] == "dns" {
    # If Query exists run a frequency analysis against it.  In order for this to work you must have
    # freq.py and the corresponding frequency table in /opt/freq/.  This is a huge boost to security
    # and I highly recommend you set this up.  Example, if a frequency score less than 6 exists
    # then there is a likelihood that something malicious is happening.
    #
    # For higher accuracy, please generate your own frequency tables.  For questions on setup,
    # please refer to https://github.com/SMAPPER
    if [query_type_name] == "A" or [query_type_name] == "AAAA" and "top-1m" not in [tags] and "internal_domain" not in [tags] {
      if [parent_domain] and [parent_domain_length] > 5 {
        mutate {
          add_field => { "freq_parent_domain" => "%{parent_domain}"}
        }
        mutate {
          gsub => [ "freq_parent_domain", "[^a-zA-Z0-9]", "" ]
        }
        rest {
          request => {
            url => "http://freq_server:10004/measure/%{freq_parent_domain}"
          }
          sprintf => true
	        json => false
          target => "parent_domain_frequency_score"
        }
        if [parent_domain_frequency_score] {
          mutate {
            add_field => { "frequency_scores" => "%{parent_domain_frequency_score}" }
            remove_field => [ "freq_parent_domain" ]
          }
        }
      }
      if [subdomain] and [subdomain_length] > 5 {
        mutate {
          add_field => { "freq_subdomain" => "%{subdomain}"}
        }
        mutate {
          gsub => [ "freq_subdomain", "[^a-zA-Z0-9]", "" ]
        }
        rest {
          request => {
            url => "http://freq_server:10004/measure/%{freq_subdomain}"
          }
          sprintf => true
	        json => false
          target => "subdomain_frequency_score"
        }
        if [subdomain_frequency_score] {
          mutate {
            add_field => { "frequency_scores" => "%{subdomain_frequency_score}" }
            remove_field => [ "freq_subdomain" ]
          }
        }
      }
      if [highest_registered_domain] and [highest_registered_domain_length] > 5 {
        mutate {
          add_field => { "freq_highest_registered_domain" => "%{highest_registered_domain}"}
        }
        mutate {
          gsub => [ "freq_highest_registered_domain", "[^a-zA-Z0-9]", "" ]
        }
        rest {
          request => {
            url => "http://freq_server:10004/measure/%{freq_highest_registered_domain}"
          }
          sprintf => true
	        json => false
          target => "highest_registered_domain_frequency_score"
        }
        if [highest_registered_domain_frequency_score] {
          mutate {
            add_field => { "frequency_scores" => "%{highest_registered_domain_frequency_score}" }
            remove_field => [ "freq_highest_registered_domain" ]
          }
        }
      }
    }
  }
}
